<!DOCTYPE html>
<html>
<head>
    <style>
        th, td {
            border: solid 1px black;
        }
    </style>
</head>
<body>
    <h1 data-cy="page-header">Harvest Report</h1>
    
    <p>This page is a <i>mockup</i> of a simplified harvest report.</p>
    <div id="vuecontent" v-cloak>
    <form>
        <label for="title">Title: </label>
        <input data-cy="title-field" type="text" name="title" v-model="rptTitle" id="title" value="Mock Harvest Report"> 
        <br><br>
        <label for="startdate">Start: </label>
        <input type="date" min="2014-01-01" v-model="rptStartDate" v-bind:max="rptEndDate" value="2020-05-05" data-cy="start-date">
        <label for="enddate">End: </label>
        <input type="date" v-bind:min="rptStartDate" v-model="rptEndDate" max="2022-01-01" value="2020-05-15" data-cy="end-date"> <br><br>

        <dropdown-with-all :selected-val="rptCrop"  data-cy="crop-list" includes-all :dropdown-list="cropNames" @selection-changed="cropChange" :disabled="false"> Crop: 
        </dropdown-with-all>

        <label for="field">Area: </label>
        <select name="field" id="field">
            <option v-for="item in fields">{{item}}</option>
        </select>
        <br><br>

        <input type="button" value="Generate Report" @click="generateRpt" data-cy="generate-button">
    </form>

    <hr>
    <div v-if="genState === true">
    <h1 data-cy="generate-title">{{rptTitle==""? "Mock Harvest Report" : rptTitle}}</h1>
    <p>Details: </p>
    <ul>
        <li><b>Farm:</b><span data-cy="farm-name">{{rptFarm}}</span></li>
        <li><b>User:</b><span data-cy="farm-user">{{rptUser}}</span></li>
        <li><b>Language:</b><span data-cy="farm-language">{{rptLanguage}}</span></li>
    </ul>
    <br>
    <form>
    <ul>
        <li><b>Start:</b>{{rptStartDate}}</li>
        <li><b>End:</b>{{rptEndDate}}</li>
        <li><b>Crop:</b>{{rptCrop}}</li>
    </ul>
    </form>
    
    <p style="color: red;" v-if="harvestReportRows.length === 0">No matching records</p>
    <custom-table v-else data-cy="test-table"
            :columns="columns"
            :rows="harvestReportRows" 
            >
        </custom-table>

    </div>
</div>
    <script>
        Vue.config.devtools = true;
        var vuecontent = new Vue(
            {
                el:'#vuecontent',
                components: {
                    'dropdown-with-all': DropdownWithAllComponent,
                    'custom-table': CustomTableComponent,
                },
                created(){
                        console.log("HarvestReport Vue instance created!")
                        getIDToCropMap()
                        .then((theMap) => {
                            this.idToCropMap = theMap;
                        })
                        .catch((error) => {
                            console.log("Error Occured")
                            console.log(error)
                        })
                    },
                data: {
                    genState: false,
                    idToCropMap: new Map(),
                    rptTitle: "",
                    rptStartDate:'2020-05-05',
                    rptEndDate:'2020-05-15',
                    rptCrop:'All',
                    rptFarm:'',
                    rptUser:'',
                    rptLanguage:'',
                    fields: ["All", "Chuau-1", "SQ7"],
                    hlogs : [],
                    columns: [
            {"header": 'Row', "visible": true, "inputType": {'type': 'no input'}},
            {"header": 'Date', "visible": true, "inputType": {'type': 'no input'}},
            {"header": 'Area', "visible": true, "inputType": {'type': 'no input'}},
            {"header": 'Crop', "visible": true, "inputType": {'type': 'no input'}},
            {"header": 'Yield', "visible": true, "inputType": {'type': 'no input'}},
            {"header": 'Units', "visible": true, "inputType": {'type': 'no input'}},
        ],
                    
                } ,
                computed: {
                    cropNames (){ 
                        return Array.from(this.idToCropMap.values())
                        
                    },

                    harvestReportRows() {
                        let tableRows = []
                        let count = 1;
                        for(let log of this.hlogs) {
                            if (this.idToCropMap.get(log.data.crop_tid) === this.rptCrop){
                                let date = dayjs.unix(log.timestamp).format('DD/MM/YYYY');
                                let area = log.area[0].name;
                                let crop = this.idToCropMap.get(log.data.crop_tid);
                                let yield = log.quantity[0].value;
                                let units = log.quantity[0].unit.name;
                                let tableRow = {
                                    id: count,
                                    data:[count, date, area, crop, yield, units],
                            };
                            tableRows.push(tableRow);
                            count++;
                            }
                            
                        }
                        return tableRows
                    },

                },
                methods: {
                    cropChange: function (newCrop){
                        this.rptCrop = newCrop;
                    },
                    generateRpt: function(){
                        this.genState = true;
                        //Axios
                        timestampStart = dayjs(this.rptStartDate).unix();
                        timestampEnd = dayjs(this.rptEndDate).unix();
                        timestampRequest = "http://fd2_farmdata2/log.json?type=farm_harvest&timestamp[ge]=" + timestampStart + "&timestamp[le]=" + timestampEnd;
                        getAllPages(timestampRequest, this.hlogs)
                        .then(() => {
                        })
                        .catch((err) => {
                            console.log("Error Occured")
                            console.log(err);
                        })

                        axios.get('http://fd2_farmdata2/farm.json')  // this line sends the request.
                        .then((response) => {
                            this.rptFarm =response.data.name;
                            this.rptUser=response.data.user.name;
                            this.rptLanguage=response.data.languages.en.name;
                            
                        })
                        .catch((error) => {
                            console.log("Error Occured")
                            console.log(error)
                        })
                    }
                }
                
            }
        )
    </script>
</body>
</html>