<html>
  <div id="vue-harv" v-cloak>  
    <h1 data-cy="page-header">Harvest Report</h1>
        <p> This page is a <i>mockup</i> of a simplified harvest report.</p>
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" v-model="rptTitle"/> <br> <br>
       
        <form>
            <label>
              Start:
              <input data-cy="start-date" type="date" name="start" v-model="rptStart" min="2014-01-01" v-bind:max="rptEnd" />
            </label> 
            <label>
                End:
                <input data-cy="end-date" type="date" name="end" v-model="rptEnd" v-bind:min="rptStart" max="2022-01-01" />
              </label>
        </form><br>
          

        <label for="crop">Crop:</label>
        <select data-cy="crop-dropdown" id="crop" name="crop" v-model="rptCrop">
            <option selected v-for="crop in cropNames">{{crop}}</option>  
        </select>
        <label for="field">Field:</label>
        <select id="field" name="field">
            <option v-for = "area in areas">{{area}}</option> 
        </select>
        <br> <br>
          
        <button data-cy="generate-report-button" type="button" v-on:click='genReport'>Generate Report</button>
    <hr> 
    <div v-if="showReport === 'reveal'">
            <h1 data-cy="report-title" v-cloak> {{ rptTitle=="" ? "Mock Harvest Report" : rptTitle}} </h1>
                <p> Details: </p>
                <ul>
                    <li data-cy="farm-name"><b>Farm</b>:{{ farmName }}</li>
                    <span data-cy="user-id"><b>User</b>:{{ userID }}</span>
                    <span data-cy="language"><b>Language</b>:{{ language }}</span><br>
                    <li><b>Start</b>:{{ rptStart }}</li>
                    <li><b>End</b>:{{ rptEnd }}</li>
                    <li><b>Crop</b>:{{ rptCrop }}</li>
                </ul>
            <p v-if="harvestReportRows.length === 0">There are no matching records!</p>
            <div v-if="harvestReportRows.length !== 0">
                <table border="1">
                    <tr>
                        <th>Row</th>
                        <th>Date</th>
                        <th>Area</th>
                        <th>Crop</th>
                        <th>Yield</th>
                        <th>Units</th>
                    </tr>
                    <tr v-for = "(data,index) in harvestReportRows">
                        <td >{{index + 1}}</td>
                        <td >{{data.date}}</td>
                        <td >{{data.area}}</td>
                        <td >{{data.crop}}</td>
                        <td >{{data.yield}}</td>
                        <td >{{data.units}}</td>
                    </tr>
                </table>
            </div>
    </div>
  </div>      
  <script>
    var vueHarv = new Vue ({
        el: '#vue-harv',
        data: {
            rptTitle: "My Sample Report",
            rptStart: '2020-05-05',
            rptEnd: '2020-05-15',
            rptCrop: 'Kale',
            crops: [
                "Kale",
                "Broccoli",
                "Peas"
            ],
            areas: [
                "All",
                "Chuau-1",
                "SQ7"
            ],

            tablesFromAPI: [],
            farmName: 'Sample FarmName',
            userID: '',
            language: 'English',
            idToCropMap: new Map(),
            showReport: "hidden",
        },
        computed: {
            cropNames() {
                return Array.from(this.$data.idToCropMap.values());
            },
            harvestReportRows() {
                let tableRows = []
                for(let log of this.tablesFromAPI) {
                    if(this.idToCropMap.get(log.data.crop_tid) == this.rptCrop){
                        let tableRow = {
                            date: dayjs.unix(log.timestamp).format('YYYY-MM-DD'),
                            area: log.area[0].name,
                            crop: this.idToCropMap.get(log.data.crop_tid),
                            yield: log.quantity[0].value,
                            units: log.quantity[0].unit.name,
                        }
                        tableRows.push(tableRow)
                    }
                }
                return tableRows
            },
        },
        methods: {
            genReport: function() {

                this.showReport = 'reveal';
                
                axios.get('/farm.json')
                .then((response) => {
                    this.farmName = response.data.name;
                    this.userID = response.data.user.name;
                    this.language = response.data.languages.en.name;
                })
                .catch((error) =>{
                    console.log('Error Occured')
                    console.log(error)
                })

                    let srtDateTS = dayjs(this.rptStart).unix();
                    let endDateTS = dayjs(this.rptEnd).unix();

                    let req = "/log.json?type=farm_harvest&timestamp[ge]="+srtDateTS+"&timestamp[le]="+endDateTS;

                    getAllPages(req, this.tablesFromAPI)
                    .then(() => {
                      
                    })
                    .catch((err) => {
                         console.log("Error in getAllPages step.")
                    })
            },
            changeState: function(newState){
                this.state = newState;
            },
        },
        created() { 
            getIDToCropMap()
            .then((theMap) => {
                this.idToCropMap = theMap;
            })
            .catch((error) => {
                console.log("getIDToCropMap caught an error.")
            })
        }, 
    });
    Vue.config.devtools = true; 
</script>
</html>
