<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Harvest Report</title>
  </head>
  <body>
    <div id="pageContent" v-cloak>
        <h1 data-cy="page-header">Harvest Report</h1>
        <p>This page is a <i>mockup</i> of a simplified harvest report.</p>
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" v-model="reportTitle"/>
        <br><br>
        <label for="start">Start:</label>
            <input type="date" id="start" name="start"
            v-model="reportStartDate"
            min="2014-01-01" :max="reportEndDate" data-cy="start-date">
            <label for="end">End:</label>
            <input type="date" id="end" name="end"
                v-model="reportEndDate"
                :min="reportStartDate" max="2022-01-01" data-cy="end-date">
        <br><br>
        <label for="crop">Crop:</label>
        <dropdown-with-all name="crop" data-cy="crop-dropdown"
            includes-all
            :selected-val="reportCrop"
            :dropdown-list="cropNames"
            @selection-changed="cropChange"
        ></dropdown-with-all>
        <label for="field">Field:</label>
        <select id="field" name="field">
            <option selected v-for="area in areaNames">{{area}}</option>
        </select>
        <br><br>
        <input type="button" value="Generate Report" @click="addHarvestLog" data-cy="generate-report-button">
        <div v-if="showReport === 'true'">
            <hr>
            <h1 data-cy="report-title">{{reportTitle ? reportTitle:"Mock Harvest Report"}}</h1>
            <p>Details:
                <ul> 
                    <li data-cy="farm-name"><strong>Farm:</strong>{{reportFarm}}</li>
                    <li data-cy="username"><strong>User:</strong>{{reportUser}}</li>
                    <li><strong>Language:</strong><span data-cy="language">{{reportLanguage}}</span></li>
                    <br>
                    <li><strong>Start:</strong>{{reportStartDate}}</li>
                    <li><strong>End:</strong>{{reportEndDate}}</li>
                    <li><strong>Crop:</strong>{{reportCrop}}</li>
                </ul>
            </p>
            <custom-table v-if="rows.length > 0" data-cy="harvest-report-table"
                can-edit
                can-delete
                :columns="columns"
                :rows="rows" 
            ></custom-table>
            <p v-else>No matching records found</p>
        </div>
    </div>
    <script>
        let mainVue = new Vue({
            el: "#pageContent",
            created() {
	            getIDToCropMap()
                .then((theMap) => {
                    this.$data.idToCropMap = theMap
                })
                .catch((err) => {
                    console.log("Error Occurred")
                    console.log(error)
                })
                getIDToAreaMap()
                .then((theMap) => {
                    this.$data.idToAreaMap = theMap
                })
                .catch((err) => {
                    console.log("Error Occurred")
                    console.log(error)
                })
            },
            components: {
                'dropdown-with-all': DropdownWithAllComponent,
                'custom-table': CustomTableComponent,
            },
            data:{
                reportTitle: "My Sample Report",
                reportStartDate: "2020-05-05",
                reportEndDate: "2020-05-15",
                reportCrop: "All",
                reportFarm: "",
                reportUser: "",
                reportLanguage: "",
                showReport: "false",
                idToCropMap: new Map(),
                idToAreaMap: new Map(),
                harvestLogs: [],
                columns:[
                    {"header":'Date', "visible":true, "inputType":{'type':'no input'}},
                    {"header":'Area', "visible":true, "inputType":{'type':'no input'}},
                    {"header":'Crop', "visible":true, "inputType":{'type':'no input'}},
                    {"header":'Yield', "visible":true, "inputType":{'type':'no input'}},
                    {"header":'Unit', "visible":true, "inputType":{'type':'no input'}}
                ],
            },
            computed:{
                cropNames(){
                    return Array.from(this.$data.idToCropMap.values());
                },
                areaNames(){
                    return Array.from(this.$data.idToAreaMap.values());
                },
                rows(){
                    let tableRows = []
                    for(let log of this.harvestLogs) {
		                let tableRow = {
                            id: log.id,
                            data: [
                                dayjs.unix(log.timestamp).format('YYYY-MM-DD'),
                                log.area[0].name,
                                this.idToCropMap.get(log.data.crop_tid),
                                log.quantity[0].value,
                                log.quantity[0].unit.name,
                            ]
		                }
                        if(tableRow.data[2] == this.reportCrop || this.reportCrop == "All"){
                            tableRows.push(tableRow)
                        }
                    }
                    return tableRows
                },
            },
            methods:{
                addHarvestLog: function(){
                    if(this.showReport === "false"){
                        axios.get('/farm.json')
                        .then((response) => {
                            this.$data.reportFarm = response.data.name
                            this.$data.reportUser = response.data.user.name
                            this.$data.reportLanguage = response.data.languages.en.name
                        })
                        .catch((error) => {
                            console.log("Error Occurred")
                            console.log(error)
                        })
                        this.showReport = 'true'

                        let startDate = dayjs(this.$data.reportStartDate).unix();
                        let endDate = dayjs(this.$data.reportEndDate).unix();
                        let request = "/log.json?type=farm_harvest&timestamp[ge]="+startDate+"&timestamp[le]="+endDate;

                        getAllPages(request, this.$data.harvestLogs)
                        .then(() => {
                        })
                        .catch((err) => {
                        console.log(err)
                        })
                    }
                    else{
                        let startDate = dayjs(this.$data.reportStartDate).unix();
                        let endDate = dayjs(this.$data.reportEndDate).unix();
                        let request = "/log.json?type=farm_harvest&timestamp[ge]="+startDate+"&timestamp[le]="+endDate;
                        
                        this.$data.harvestLogs = []
                        getAllPages(request, this.$data.harvestLogs)
                        .then(() => {
                        })
                        .catch((err) => {
                        console.log(err)
                        })
                    }
                },
                cropChange(newCrop) {
                    this.reportCrop = newCrop
                },
            }
        });
        Vue.config.devtools = true;
    </script>
  </body>
</html>