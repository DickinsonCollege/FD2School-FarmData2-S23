<h1 data-cy="page-header">Harvest Report</h1>
<p>This page is a <i>mockup</i> of a simplified harvest report.</p>
    
<div v-cloak id="vueReport">
    
    <label for="title">Title: </label>
    <input id="title" type="text" v-model="reportTitle">
    <br>
    <br>

    <label for="start-date">Start: </label>
    <input data-cy="start-date" type="date" id="start-date" min="2014-01-01" :max="reportEndDate" v-model="reportStartDate">
    <label for="end-date">End: </label>
    <input data-cy="end-date" type="date" id="end-date" :min="reportStartDate" max="2022-01-01" v-model="reportEndDate">
    <br>
    <br>

    <label for="crop"></label>
    <dropdown-with-all data-cy="crop-drop-down"
        includes-all
        id="crop"
        :dropdown-list="cropNameToArray" 
        :selected-val="reportCrop"
        :disabled="false"
        @selection-changed="cropChange">
    Crop:
    </dropdown-with-all>

    <label for="field">Field: </label>
    <select id="field">
        <option v-for="area in areaNameToArray">{{ area }}</option>
    </select>
    <br>
    <br>

    <button data-cy="generate-button" @click="generateReport" >Generate Report</button>
    
    
    <div v-if="reportState==='generated'">
        <hr>
        
        <h2 data-cy="report-title">{{ reportTitle ? reportTitle : "Mock Harvest Report" }}</h2>
        <p>Details:</p>
        <ul>
            <li ><strong>Farm:</strong><span data-cy="farm-name">{{ farm }}</span></span></li>
            <li><strong>User:</strong>{{ user }}</li>
            <li><strong>Language:</strong>{{ language }}</li>
            <br>
            <li><strong>Start:</strong>{{ reportStartDate }}</li>
            <li><strong>End:</strong>{{ reportEndDate }}</li>
            <li><strong>Crop:</strong>{{ reportCrop }}</li>
        </ul>

        <p v-if="harvestReportRows.length === 0">There is no harvest logs to display.</p>
        <div v-else>
            <custom-table data-cy="test-table"
                :columns="columns"
                :rows="harvestReportRows">
            </custom-table>
        </div>
    </div>
</div>

<script>
    var vueReportVar = new Vue ({
        created() {
            //console.log("HarvestReport Vue instance created!")
            getIDToCropMap()
                .then((theMap) => {
                    this.idToCropMap = theMap;
                })
                .catch((err) => {
                    console.log("Error Occurred");
                    console.log(err);
                }),

            getIDToAreaMap()
                .then((theMap) => {
                    this.idToAreaMap = theMap;
                })
                .catch((err) => {
                    console.log(err);
                })
        },

        el: "#vueReport",

        components: {
        'dropdown-with-all': DropdownWithAllComponent,
        'custom-table': CustomTableComponent,
        },

        data: {
            reportTitle: "My Sample Report",
            reportStartDate: "2020-05-05",
            reportEndDate: "2020-05-15",
            reportCrop: "All",
            areas: ["All", "Chuau-1", "SQ7"],
            harvestLog: [],
            idToAreaMap: new Map(),
            reportState: "generated",
            farm: "",
            user: "",
            language: "",
            idToCropMap: new Map(),
            result: [],

            columns: [
                {"header": 'Row', "visible": true, "inputType": {'type': 'no input'}},
                {"header": 'Date', "visible": true, "inputType": {'type': 'no input'}},
                {"header": 'Area', "visible": true, "inputType": {'type': 'no input'}},
                {"header": 'Crop', "visible": true, "inputType": {'type': 'no input'}},
                {"header": 'Yield', "visible": true, "inputType": {'type': 'no input'}},
                {"header": 'Units', "visible": true, "inputType": {'type': 'no input'}},
            ],
        },
        computed: {
            cropNameToArray(){
                return Array.from(this.idToCropMap.values());
            },

            areaNameToArray(){
                return Array.from(this.idToAreaMap.values());
            },

            harvestReportRows() {
                let tableRows = []
                for(let log of this.result) {
                    index = 0
                    id = log.id
                    date = dayjs.unix(log.timestamp).format('YYYY-MM-DD')
                    area = log.area[0].name
                    crop = this.idToCropMap.get(log.data.crop_tid)
                    yield = log.quantity[0].value
                    units = log.quantity[0].unit.name
                
                if (crop == this.reportCrop || this.reportCrop == 'All'){
                    let tableRow = {
                        id: index,
                        data: [id, date, area, crop, yield, units]
                    }
                    tableRows.push(tableRow)
                }
                
                    
                }
                return tableRows
            },


        },

        methods: {
            generateReport: function(){
                axios.get('/farm.json')
                .then((response) => {
                    this.farm = response.data.name;
                    this.user = response.data.user.name;
                    this.language = response.data.languages.en.name;
                    
                })
                .catch((error) => {
                    console.log("Error Occurred!");
                    console.log(error);
                })

                let startDateTimestamp = dayjs(this.reportStartDate).unix();
                let endDateTimestamp = dayjs(this.reportEndDate).unix();
                let requestString = "/log.json?type=farm_harvest&timestamp[ge]=" + startDateTimestamp.toString() + "&timestamp[le]="+ endDateTimestamp.toString();
                
                getAllPages(requestString, this.result)
                .then(() => {
                    
                })
                .catch((err) => {
                    console.log(err);
                })

            },

            deleteButton: function(logIndex){
                this.harvestLog.splice(logIndex, 1)
            },
            
            changeState: function(newState){
                this.reportState = newState;
            },

            cropChange: function(newCrop){
                this.reportCrop = newCrop;
            },
        }
    });
    Vue.config.devtools = true;
</script>