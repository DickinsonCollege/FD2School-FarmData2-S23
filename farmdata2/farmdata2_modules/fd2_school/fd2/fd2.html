<h1 data-cy="page-header">Harvest Report</h1>
<p>This page is a <i>mockup</i> of a simplified harvest report.</p>
<div id="SampleHarvestReport" v-cloak>
  <label for=”reportTitle”>Title: </label>
  <input type="text" id="reportTitle" name="reportTitle" value="My Sample Harvest Report" v-model="reportTitle" />
  <br>
  <br>
  <label for="reportStartDate">Start: </label>
  <input data-cy="start-date" type="date" id="reportStartDate" name="reportStartDate" min="2014-01-01"
    :max="reportEndDate" v-model="reportStartDate">
  <label for="reportEndDate">End: </label>
  <input data-cy="end-date" type="date" id="reportEndDate" name="reportEndDate" :min="reportStartDate" max="2022-01-01"
    v-model="reportEndDate">
  <br>
  <br>
  <dropdown-with-all data-cy="crop-dropdown-menu" includes-all :selected-val="reportCrop" :dropdown-list="cropNames"
    @selection-changed="cropChange">
    Crop:
  </dropdown-with-all>
  <label for="reportFields">Field: </label>
  <select id="reportFields" name="reportFields">
    <option v-for="reportField in reportFields">{{reportField}}</option>
  </select>
  <br>
  <br>
  <button data-cy="generate-report-button" type="button" @click="generateLog">Generate Report</button>
  <div v-if="reportDisplayFlag === true">
    <hr>
    <h1 data-cy="harvest-report-title">{{reportTitle == ""? "Mock Harvest Report":reportTitle}}</h1>
    <p>Details:</p>
    <ul>
      <li data-cy="farm-name"><strong>Farm:</strong>{{reportFarmName}}</li>
      <li data-cy="user-name"><strong>User:</strong>{{reportUserName}}</li>
      <li><strong>Language:</strong><span data-cy="language">{{reportLanguage}}</span></li>
      <br>
      <li><strong>Start:</strong>{{reportStartDate}}</li>
      <li><strong>End:</strong>{{reportEndDate}}</li>
      <li><strong>Crop:</strong>{{reportCrop}}</li>
    </ul>
    <br>
    <br>
    <custom-table v-if="rows.length > 0" data-cy="harvest-report-table"  
      can-delete 
      :columns="columns"
      :rows="rows">
    </custom-table>
    <p v-else>There are no matching records</p>
  </div>

</div>
<script>
  var reportVar = new Vue({
    el: '#SampleHarvestReport',
    created() {
      getIDToCropMap()
        .then((theMap) => {
          this.reportIDToCropMap = theMap
        })
        .catch((theMap) => {

        })

    },

    components: {
      // Register the components used and define the tag name to be used.
      'dropdown-with-all': DropdownWithAllComponent,
      'custom-table': CustomTableComponent,
    },

    data: {
      reportTitle: "My Sample Harvest Report",
      reportStartDate: "2020-05-05",
      reportEndDate: "2020-05-15",
      reportCrop: "All",
      reportFields: ["All", "CHUAU-1", "SQ7"],
      reportFarmName: "",
      reportUserName: "",
      reportLanguage: "",
      reportLogArray: [],
      columns: [
        { "header": 'Date', "visible": true, "inputType": { 'type': 'no input' } },
        { "header": 'Area', "visible": true, "inputType": { 'type': 'no input' } },
        { "header": 'Crop', "visible": true, "inputType": { 'type': 'no input' } },
        { "header": 'Yield', "visible": true, "inputType": { 'type': 'no input' } },
        { "header": 'Unit', "visible": true, "inputType": { 'type': 'no input' } }
      ],
      reportIDToCropMap: new Map(),
      reportDisplayFlag: false,
    },

    computed: {
      cropNames: function () {
        return Array.from(this.reportIDToCropMap.values())
      },

      rows() {
        let tableRows = []
        for (let log of this.reportLogArray) {
          let tableRow = {
            id: log.id,
            data: [
              dayjs.unix(log.timestamp).format('YYYY-MM-DD'),
              log.area[0].name,
              this.reportIDToCropMap.get(log.data.crop_tid),
              log.quantity[0].value,
              log.quantity[0].unit.name,
            ]
          }
          if (tableRow.data[2] == this.reportCrop || this.reportCrop == "All") {
            tableRows.push(tableRow)
          }
        }
        return tableRows
      },

    },

    methods: {
      generateLog: function () {
        axios.get('/farm.json')
          .then((response) => {
            this.reportFarmName = response.data.name
            this.reportUserName = response.data.user.name
            this.reportLanguage = response.data.languages.en.name
          })
          .catch((error) => {

          })
        let startTimestamp = dayjs(this.reportStartDate).unix()
        let endTimestamp = dayjs(this.reportEndDate).unix()
        let logDateQuery = "/log.json?type=farm_harvest&timestamp[ge]=" + startTimestamp + "&timestamp[le]=" + endTimestamp

        getAllPages(logDateQuery, this.reportLogArray)
          .then(() => {
            Ï
          })
          .catch((err) => {

          })
        this.reportDisplayFlag = true
      },

      cropChange: function (newCrop) {
        this.reportCrop = newCrop
      },
    }
  })
  Vue.config.devtools = true;
</script>