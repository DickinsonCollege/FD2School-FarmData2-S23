<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    
  </head>
  
  
    <div v-cloak id="vuespike">
     
    <h1 data-cy="page-header"> Harvest Report</h1>
   
   
    <p>This page is a <i>mock up</i>  of a simplified harvest report</p>
    <form>
      <label for="title">Title:</label>
      <input v-model="titleReport" type="text" id="title" name="title" placeholder="harvest sample report" >
      <br><br>
      <label for="start">Start:</label>
      <input data-cy="start-date" v-model="startDate"  type="date" id="start" name="date"   min="2014-01-01" v-bind:max="endDate" > 
      
      <label for="end">End:</label>
      <input data-cy="end-date" v-model="endDate" type="date" id="end" name="date" v-bind:min="startDate" max="2022-01-01" >
      <br><br>
      <label for="crop">Crop:</label>
      <!-- <select data-cy="crop-item" v-model="crop" name="crop" id="crop">
        <option v-for="crop in reverseCropIDandName">{{crop}}</option>
        
      </select> -->
      <dropdown-with-all data-cy="crop-dropdown" 
      includes-all 
      :selected-val='crop'
      :dropdown-list='reverseCropIDandName'
      @selection-changed="cropChange"
      :disabled="false">
  Pick a Crop: 
  </dropdown-with-all>
      <label for="field">Field:</label>
  <select v-model="field" name="field" id="field">
    <option v-for="field in fieldList">{{field}}</option>
    
  </select>
    </form>
    <br>
    <button data-cy="generate-report-button" type="button" v-on:click='generateReport'>Generate Report</button>
    <hr>
    <h1 data-cy="tittleReport" v-if="cropdoc.titleReport">{{cropdoc.titleReport}}</h1>
    <!-- <h1 v-else>no matching record</h1> -->
   <p>Details:</p>
  

    <custom-table data-cy="test-table"
            
            
            :columns="columns"
            :rows="tableRow" 
            :custom-buttons="myButtons"
            
            >
        </custom-table>
   
   

   

  </div>
  </body>
  <script>
    var vueSpike=new Vue({
        el:'#vuespike',
        
                 data:{
                  result:[],
                  idToCropMap: new Map(),
                  farm:"Sample farm",
                  user:"worker1",
                  language:"English",
             cropdoc:{
                            titleReport:"",
                          startDate:"",
                          endDate:"",
                         crop:"",
                         field:"",
                         farm:"",
                         user:"",
                         language:""

             },

              titleReport:'',  
             
                                
                           startDate:"2020-05-05" ,
                           endDate:"2020-05-15" ,
                          
                           cropList:["Kale","Broccoli","Peas"],
                           fieldList:["Chuau-1","Chuau-2","Chuau-3"],
                           field:"Chuau-1",
                           crop:"All",
                           


                           columns: [
                        // {"header": 'ID', "visible": true, "inputType": {'type': 'no input'}},
            {"header": 'Date', "visible": true, "inputType": {'type': 'date'}},
            {"header": 'Area', "visible": true, "inputType": {'type': 'dropdown','value': ['Chuau-1','Chuau-2','Chuau-3']}},
            {"header": 'Crop', "visible": true, "inputType": {'type': 'dropdown','value': this.reverseCropIDandName}},
            {"header": 'yield', "visible": true, "inputType": {'type': 'text'}},
            {"header": 'unit', "visible": true, "inputType": {'type': 'dropdown','value': ['Bunch','Pound']}},
            ],
            
            myButtons: [
            {"hoverTip": 'Clone', "visible": true, "inputType": {'type': 'button', 'value': 'glyphicon glyphicon-asterisk', 'buttonClass': 'table-button btn btn-warning', 'event': 'clone'}},
        ],
            
        },
        created() {
          getIDToCropMap()
.then((theMap) => {
  console.log(theMap);
    this.idToCropMap=theMap;
})
.catch((err) => {
    console.log(err);
})
	console.log("HarvestReport Vue instance created!")
},
components:{
'dropdown-with-all': DropdownWithAllComponent,
'custom-table':CustomTableComponent
},
computed :{
  tableRow(){

tablerow= []
rawRow=this.harvestReportRows
for (let i=0;i<rawRow.length;i++){
  rowdata =[rawRow[i].date,rawRow[i].area,rawRow[i].crop, rawRow[i].yield,rawRow[i].units]
  
  row=  {
   id:i,
    data:rowdata
}
  tablerow.push(row)
  
}
return tablerow

  },
  reverseCropIDandName(){

reverse=[]
for (let[key,val] of this.idToCropMap){
    reverse.push(val)
    
  }
  return reverse
},
harvestReportRows() {
	tableRows=[]
  results=this.result
  
	for(let log of results) {
    
		let tableRow = {
			date: dayjs.unix(log.timestamp).format('DD/MM/YYYY'),
      area:log.area[0].name,
     
      
      crop: this.idToCropMap.get(log.data.crop_tid),
      yield:log.quantity[0].value,
      units:log.quantity[0].unit.name,
    }
    if (this.crop==='All'){
      tableRows.push(tableRow)
    }
    else if (tableRow.crop===this.crop){
      tableRows.push(tableRow)
    }
	
	}
	 return tableRows
}

},
        methods : {
generateReport: function(){
  console.log(this.endDate)
  if (this.titleReport!=""){
    this.cropdoc.titleReport=this.titleReport
  }
  else{
    this.cropdoc.titleReport="mock report"
  }
 
  this.cropdoc.startDate=this.startDate
  this.cropdoc.endDate=this.endDate
  this.cropdoc.crop=this.crop
  this.cropdoc.field=this.field
  this.cropdoc.user=this.user
  this.cropdoc.language=this.language
  this.cropdoc.farm=this.farm
  
  let startday=dayjs(this.startDate).unix();
  let endday=dayjs(this.endDate).unix();



let request= "/log.json?type=farm_harvest&timestamp[ge]="+startday+"&timestamp[le]="+endday

getAllPages(request, this.result)
.then(() => {
    
})
.catch((err) => {
    console.log(err)
})

},

cropChange: function (newCrop){
this.crop=newCrop
}
        }

    })
    Vue.config.devtools = true;
</script>
</html>
