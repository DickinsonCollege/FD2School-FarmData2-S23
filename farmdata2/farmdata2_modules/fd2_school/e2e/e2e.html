<div id ="report" v-cloak>
    <h1 data-cy="page-header">Harvest Report</h1>
    <br />
    <label for = "title">Title</label>
    <input name = "title" type = "text" id = "title" v-model  = "rptTitle"/>
    
    <br />
    <br />
    <label for="start">Start</label>
    <input data-cy="start-date"  type="date" id="start" name="Start Date"
           v-model = "rptStartDate"
           min="2014-01-01" :max="rptEndDate">
    <label for="end">End</label>
    <input data-cy="end-date" type="date" id="end" name="End-Date"
           v-model = "rptEndDate"
           :min="rptStartDate" max="2022-01-01">
    <br />
    <br />
    <label for = "crop">Crop</label>
    <select id = "crop" name = "crop" v-model = "rptCrop">
        <option v-for = "crop in cropNames">{{crop}}</option>
    
    </select>
    
    <label for = "field">Area</label>
    <select id = "field" name = "field" >
        <option v-for ="area in areaNames">{{area}}</option>
    </select>
    <br >
    <br />
    <button type = "submit" @click = 'saveHarvest'> Generate Report </button>
    <br />
    <br />
    <hr />
    
    <h1>{{ rptTitle== ''?'Mock Harvest Report':rptTitle }}</h1>
    
    
    <br />
    <br />
    
    <p>Details:</p>
    <ul>
        <li><strong>Farm: </strong>{{farm}}</li>
        <li><strong>User: </strong>{{user}}</li>
        <li><strong>Language: </strong>{{language}}</li>
        <br />
        <br />
        <li><strong>Start: </strong>{{ rptStartDate }}</li>
        <li><strong>End: </strong>{{ rptEndDate }}</li>
        <li><strong>Crop: </strong>{{rptCrop}}</li>
        
    </ul>
    <br />
    <p v-if = "harvestLog.length===0">No matching Records</p>
    <table v-if = "harvestReportRows.length>0" border = "1">
        
        <th><strong>Row</strong></th>
        <th><strong>Date</strong></th>
        <th><strong>Area</strong></th>
        <th><strong>Crop</strong></th>
        <th><strong>Yield</strong></th>
        <th><strong>Units</strong></th>
        <tr v-for = "(harvestRow, index) in harvestReportRows" v-if ="rptCrop==harvestRow.crop">
            <td>{{index}}</td>
            <td>{{harvestRow.date}}</td>
            <td>{{harvestRow.area}}</td>
            <td>{{harvestRow.crop}}</td>
            <td>{{harvestRow.yield}}</td>
            <td>{{harvestRow.units}}</td>
        </tr>
      
    </table>
    </div>
    <script>
    
        var myPage = new Vue({
                el: "#report",
                data: {
                    rptTitle: "My Sample Harvest Report",
                    rptStartDate : "2020-05-05",
                    rptEndDate : "2020-05-15",
                    rptCrop: "Kale",
                    harvestLog: [],
                    farm:"",
                    user:"",
                    language:"",
                    idToCropMap: new Map(),
                    idToAreaMap: new Map(),
                    //allPages:["ds"],
                    allHarvestPage:[],
                },
                computed:{
                    cropNames(){
                        return Array.from(this.idToCropMap.values());
                    },
                    areaNames(){
                        return Array.from(this.idToAreaMap.values());
                    },

                    harvestReportRows(){
                        let tableRows = []
                        for(let log of this.allHarvestPage){
                            let tableRow={
                                date: dayjs.unix(log.timestamp).format('DD/MM/YYYY'),
                                area: log.area[0].name,
                                units: log.quantity[0].unit.name,
                                yield: log.quantity[0].value,
                                crop: this.idToCropMap.get(log.data.crop_tid),

                            }
                            tableRows.push(tableRow)
                        }
                        return tableRows
                    }
                },

                methods:{
                    saveHarvest: function(){

                        axios.get('/farm.json')
                        .then((response) =>{
                            this.farm = response.data.name;
                            this.user = response.data.user.name;
                            this.language =response.data.languages.en.name;
                        })
                        .catch((error)=>{
                            console.log('Error Occurred')
                            console.log(error)
                        })
                       

                        let startTimeStamp = dayjs(this.rptStartDate).unix();
                        let endTimeStamp = dayjs(this.rptEndDate).unix();

                        let x = "/log.json?type=farm_harvest&timestamp[ge]="+startTimeStamp+"&timestamp[le]="+endTimeStamp;
                        console.log(x);
                        getAllPages(x,this.allHarvestPage)
                        .then(()=>{         
                        })
                        .catch((error)=>{
                            console.log(error);
                        })

                        
                    },
                },

                created(){
                    getIDToCropMap()
                    .then((theMap)=>{
                       
                        this.idToCropMap = theMap;
                        
                    })
                    .catch((error)=>{
                        console.log(error)
                    })

                    getIDToAreaMap()
                    .then((theMap)=>{
                       
                        this.idToAreaMap = theMap;
                        
                    })
                    .catch((error)=> {
                        console.log(error);
                    })
                },

            });
            Vue.config.devtools = true
        </script>