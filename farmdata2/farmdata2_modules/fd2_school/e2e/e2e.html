<h1 data-cy="page-header">Harvest Report</h1>
<p>This page is a <em>mockup</em> of a simplified harvest report.</p>
<div id="report">
  <label for="title">Title:</label>
  <input type="text" id="title" name="Title" v-model="header" />
  <br />
  <label for="start">Start:</label>
  <input
    type="date"
    id="start"
    name="start"
    v-model="startDate"
    v-bind:min="startDate"
    v-bind:max="endDate"
    data-cy="start-date"
  />
  <label for="end">End:</label>
  <input
    type="date"
    id="end"
    name="end"
    v-model="endDate"
    v-bind:min="startDate"
    v-bind:max="endDate"
    data-cy="end-date"
  />
  <br />
  <label for="crop">Crop:</label>
  <select data-cy="crop-drop-down" id="crop" v-model="rpCrops">
    <option v-for="crop in cropNames" :value="crop">{{crop}}</option>
  </select>
  <label for="area">Area:</label>
  <select id="area">
    <option v-for="area in areaNames" :value="area">{{area}}</option>
  </select>
  <br />
  <br />
  <button type="button" data-cy="generate-report-button" @click="createRequest(); setUserInfo(); changeState('show')">Generate Report</button>
  <hr />
  <h1 data-cy="report-title">{{ header ? header : 'Mock Harvest Report' }}</h1>
  <p>Details:</p>
  <ul>
      <li><strong>Farm:</strong><span data-cy="farm-name">{{farm}}</span></li>
      <li><strong>User:</strong>{{user}}</li>
      <li><strong>Language:</strong>{{language}}</li>
  </ul>
  <br />
  <ul>
      <li><strong>Start:</strong>{{startDate}}</li>
      <li><strong>End:</strong>{{endDate}}</li>
      <li><strong>Crop:</strong>{{rpCrops}}</li>
  </ul>
  <br>
  <table border="1">
      <colgroup span="5"></colgroup>
      <tr v-if="harvestReportRows.length > 0">
        <th>Row</th>
        <th>Date</th>
        <th>Area</th>
        <th>Crop</th>
        <th>Yield</th>
        <th>Units</th>
      </tr>
      
      <p v-else>No available records. Please update your search.</p>

      <tr v-for="(log, index) in harvestReportRows">
          <td>{{index + 1}}</td>
          <td>{{log.date}}</td>
          <td>{{log.area}}</td>
          <td>{{log.crop}}</td>
          <td>{{log.yield}}</td>
          <td>{{log.units}}</td>
      </tr>
  </table>
  <br />
</div>

<script>
  var myReport = new Vue({
    el: "#report",
    data: {
      header: "My Sample Harvest Report",
      state: "default",
      startDate:"2020-05-05",
      endDate: "2020-05-15",
      rpCrops: "",
      crops: [
                "Broccoli",
                "Kale",
                "Peas"
            ],
      areas: [
                "All",
                "Chuau-1",
                "SQ7",
             ],
      harvestLogs: [],
      farm: "",
      user: "",
      language: "",
      idToCropMap: new Map(),
      idToAreaMap: new Map(),
    },
    methods: {
        changeState: function() {
            this.state = newState;
        },

        setUserInfo: function() {
            axios.get('/farm.json')
                  .then((response) => {
                      this.farm = response.data.name;
                      this.user = response.data.user.name;
                      this.language = response.data.languages.en.name;
                      console.log(response);
                  })
                  .catch((error) => {
                      console.log("Error Occurred.");
                      console.log(error);
                  })
        },

        createRequest: function() {
            let sDate = dayjs(this.startDate).unix();
            let eDate = dayjs(this.endDate).unix();
            let request = `/log.json?type=farm_harvest&timestamp[le]=${eDate}&timestamp[ge]=${sDate}`;
            getAllPages(request, this.harvestLogs)
            .then(() => {
                console.log('Request made successfully.');
            })
            .catch((err) => {
                console.log(err);
            })
    }
    },

    created() {
      getIDToCropMap()
            .then((map) => {
                this.idToCropMap = map;
            })
            .catch((error) => {
                console.log("Error occurred.");
                console.log(error);
            }),
      getIDToAreaMap()
            .then((map) => {
                this.idToAreaMap = map;
            })
            .catch((error) => {
                console.log("Error occurred.");
                console.log(error);
            })
    },

    computed: {
            cropNames() {
                cropNames = [];
                for (var name of this.idToCropMap.values()) {
                    cropNames.push(name);
                }
                return cropNames
            },
            areaNames() {
                areaNames = [];
                for (var name of this.idToAreaMap.values()) {
                    areaNames.push(name);
                }
                return areaNames
            },
            harvestReportRows() {
	            let tableRows = []

                getIDToCropMap()
                .then((map) => {
                    this.idToCropMap = map
                })
                .catch((err) => {
                    console.log(err)
                })   

	            for(let log of this.harvestLogs) {
		            let tableRow = {
                    crop: this.idToCropMap.get(log.data.crop_tid),
                    area: log.area[0].name,
                    yield: log.quantity[0].value,
                    units: log.quantity[0].unit.name,
                    date: dayjs.unix(log.timestamp).format('DD/MM/YYYY'),
		        }
                if (tableRow.crop.toUpperCase() === this.rpCrops) {
                        tableRows.push(tableRow)
                    }             
	            }
	            return tableRows
            }
        },
  });
  Vue.config.devtools = true;
</script>
