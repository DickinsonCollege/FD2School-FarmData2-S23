<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Harvest Report</title>
  </head>
  <body>
    <div id="pageContent" v-cloak>
        <h1 data-cy="page-header">Harvest Report</h1>
        <p>This page is a <i>mockup</i> of a simplified harvest report.</p>
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" v-model="reportTitle"/>
        <br><br>
        <label for="start">Start:</label>
            <input type="date" id="start" name="start"
            v-model="reportStartDate"
            min="2014-01-01" :max="reportEndDate" data-cy="start-date">
            <label for="end">End:</label>
            <input type="date" id="end" name="end"
                v-model="reportEndDate"
                :min="reportStartDate" max="2022-01-01" data-cy="end-date">
        <br><br>
        <label for="crop">Crop:</label>
        <select id="crop" name="crop" v-model="reportCrop">
            <option selected v-for="crop in cropNames">{{crop}}</option>
        </select>
        <label for="field">Field:</label>
        <select id="field" name="field">
            <option selected v-for="area in areaNames">{{area}}</option>
        </select>
        <br><br>
        <input type="button" value="Generate Report" @click="addHarvestLog">
        <div v-if="showReport === 'true'">
            <hr>
            <h1>{{reportTitle ? reportTitle:"Mock Harvest Report"}}</h1>
            <p>Details:
                <ul> 
                    <li><strong>Farm:</strong>{{reportFarm}}</li>
                    <li><strong>User:</strong>{{reportUser}}</li>
                    <li><strong>Language:</strong>{{reportLanguage}}</li>
                    <br>
                    <li><strong>Start:</strong>{{reportStartDate}}</li>
                    <li><strong>End:</strong>{{reportEndDate}}</li>
                    <li><strong>Crop:</strong>{{reportCrop}}</li>
                </ul>
            </p>
            <table v-if="harvestReportRows.length > 0" border = 1>
                <tr>
                    <th>Row</th>
                    <th>Date</th>
                    <th>Area</th>
                    <th>Crop</th>
                    <th>Yield</th>
                    <th>Unit</th>
                    <th>Delete</th>
                </tr>
                <tr v-for="(harvestLog,index) in harvestReportRows">
                    <td>{{index+1}}</td>
                    <td>{{harvestLog.date}}</td>
                    <td>{{harvestLog.area}}</td>
                    <td>{{harvestLog.crop}}</td>
                    <td>{{harvestLog.yield}}</td>
                    <td>{{harvestLog.units}}</td>
                    <td><button type="button" @click="harvestReportRows.splice(index, 1)">Delete</button></td>
                </tr>
            </table>
            <p v-else>No matching records found</p>
        </div>
    </div>
    <script>
        let mainVue = new Vue({
            el: "#pageContent",
            created() {
	            getIDToCropMap()
                .then((theMap) => {
                    this.$data.idToCropMap = theMap
                })
                .catch((err) => {
                    console.log("Error Occurred")
                    console.log(error)
                })
                getIDToAreaMap()
                .then((theMap) => {
                    this.$data.idToAreaMap = theMap
                })
                .catch((err) => {
                    console.log("Error Occurred")
                    console.log(error)
                })
            },
            data:{
                reportTitle: "My Sample Report",
                reportStartDate: "2020-05-05",
                reportEndDate: "2020-05-15",
                reportCrop: "Kale",
                reportFarm: "",
                reportUser: "",
                reportLanguage: "",
                showReport: "false",
                idToCropMap: new Map(),
                idToAreaMap: new Map(),
                harvestLogs: [],
            },
            computed:{
                cropNames(){
                    return Array.from(this.$data.idToCropMap.values());
                },
                areaNames(){
                    return Array.from(this.$data.idToAreaMap.values());
                },
                harvestReportRows() {
	                let tableRows = []
	                for(let log of this.harvestLogs) {
		                let tableRow = {
			                date: dayjs.unix(log.timestamp).format('YYYY-MM-DD'),
                            area: log.area[0].name,
                            yield: log.quantity[0].value,
                            units: log.quantity[0].unit.name,
                            crop: this.idToCropMap.get(log.data.crop_tid)
		                }
                        if(tableRow.crop == this.reportCrop){
                            tableRows.push(tableRow)
                        }
	                }
	                return tableRows
                }
            },
            methods:{
                addHarvestLog: function(){
                    if(this.showReport === "false"){
                        axios.get('/farm.json')
                        .then((response) => {
                            this.$data.reportFarm = response.data.name
                            this.$data.reportUser = response.data.user.name
                            this.$data.reportLanguage = response.data.languages.en.name
                        })
                        .catch((error) => {
                            console.log("Error Occurred")
                            console.log(error)
                        })
                        this.showReport = 'true'

                        let startDate = dayjs(this.$data.reportStartDate).unix();
                        let endDate = dayjs(this.$data.reportEndDate).unix();
                        let request = "/log.json?type=farm_harvest&timestamp[ge]="+startDate+"&timestamp[le]="+endDate;

                        getAllPages(request, this.$data.harvestLogs)
                        .then(() => {
                        })
                        .catch((err) => {
                        console.log(err)
                        })
                    }
                    else{
                        let startDate = dayjs(this.$data.reportStartDate).unix();
                        let endDate = dayjs(this.$data.reportEndDate).unix();
                        let request = "/log.json?type=farm_harvest&timestamp[ge]="+startDate+"&timestamp[le]="+endDate;

                        getAllPages(request, this.$data.harvestLogs)
                        .then(() => {
                        })
                        .catch((err) => {
                        console.log(err)
                        })
                    }
                }
            }
        });
        Vue.config.devtools = true;
    </script>
  </body>
</html>