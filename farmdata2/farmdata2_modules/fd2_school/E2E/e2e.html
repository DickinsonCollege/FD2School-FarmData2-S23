<!DOCTYPE html>

<h1 data-cy='page-header'>Harvest Report</h1>

<p>This page is a <i>mockup</i> of a simplified harvest report</p>

<div id="vue" v-cloak>
<label for="Title">Title:</label>
<input data-cy="input-title" type = 'text' name = "title" placeholder = "title" v-model="titlerp">
<br>
<label for="start">Start:</label>
<input data-cy="start-date" type="date" id="start" name="start"
       value ="2020-05-05" min="2014-01-01" max="2022-01-01" v-model="startdate" @click="rpStat = false">
<label for="End">End:</label>
<input data-cy="end-date" type="date" id="end" name="end" value="2020-05-15"
                          v-bind:min="startdate" max="2022-01-01" v-model="enddate" @click="rpStat = false">

<br><br>

<label for="Crop">Crop:</label> 
<select data-cy="crop-drop" id="crops" name="crops" v-model="crop">
    <option v-for="x in cropName">{{x}}</option>
</select>
<label for="Field">Field:</label> 
<select data-cy="area-drop" id="fields" name="fields" v-model="field">
    <option v-for="x in areaName">{{x}}</option>
</select>


<br><br>

<input data-cy="generate-button" type="button" value="Generate Report" @click='generate' v-bind:disabled="inValidDate"/>

<hr>

<div v-if="rpStat">
  <h1 data-cy="report-title">{{titlerp ? titlerp : "Mock Harvest Report"}}</h1>
  <dd>Details:</dd>
  <br>
  <ul>
      <li data-cy="farm-name"><strong>Farm</strong>: {{Farm}}</li>
      <li data-cy="user-name"><strong>User</strong>: {{User}}</li>
      <li><strong>Language</strong>: <span data-cy="language">{{Language}}</span></li>
      <br>
      <li><strong>Start</strong>: {{startdate}}</li>
      <li><strong>End</strong>: {{enddate}}</li>
      <li><strong>Crop</strong>: {{crop}}</li>
  </ul>
  <br>

  <table data-cy="table-record" border = 1>

    <tr v-if="harvestReportRows.length>0">
      <th>Row</th>
      <th>Date</th>
      <th>Area</th>
      <th>Crop</th>
      <th>Yield</th>
      <th>Units</th>
      <th>Delete</th>
    </tr>
    <tr data-cy="no-record" v-else>
      <th>No record</th>
    </tr>

    <tr v-for="(r,index) in harvestReportRows">
      <td>{{index+1}}</td>
      <td>{{r.date}}</td>
      <td>{{r.area}}</td>
      <td>{{r.crop}}</td>
      <td>{{r.yield}}</td>
      <td>{{r.units}}</td>
      <td><button v-on:click="deleteRecord">Del</button></td>
    </tr>
      <!-- <tr>
        <td>05/05/2018</td>
        <td>SQ7</td>
        <td>Kale</td>
        <td>7</td>
        <td>Bunches</td>
      </tr> -->
  </table>
</div>
</div>

<script>
  let report = new Vue({
    el: '#vue',
    data: {
      rpStat: false,
      titlerp: "My Sample Harvest Report",
      startdate: "2020-05-05",
      enddate: "2020-05-15",
      crop: "All",
      field: "All",
      harvestLogs: [ ],
      Farm: "",
      User: "",
      Language: "",
      IdToCropMap: new Map(),
      IdToAreaMap: new Map(),
      result: [],
    },

    created() {
      getIDToCropMap()
      .then((theMap) => {
        this.IdToCropMap = theMap;
      })
      .catch((error) => {
        console.log("Error");
        console.log(error);
      });

      getIDToAreaMap()
      .then((theMap) => {
        this.IdToAreaMap = theMap;
      })
      .catch((error) => {
        console.log("Error");
        console.log(error);
      })
      },
    
    computed: {
      inValidDate() {
        let inval = false;
        if (!this.enddate | !this.startdate) {
          inval = true;
        }
        return inval;
      },

      cropName() {
        let crops = Array.from(this.IdToCropMap.values());
        crops.unshift("All");
        return crops;
      },
      areaName() {
        let areas = Array.from(this.IdToAreaMap.values());
        areas.unshift("All")
        return areas;
      },
      harvestReportRows() {
        let tableRows = []
        for(let log of this.result) {
          if ((this.IdToCropMap.get(log.data.crop_tid) === this.crop & log.area[0].name ===this.field ) | 
          (this.crop == "All" & log.area[0].name ===this.field) | (this.IdToCropMap.get(log.data.crop_tid) === this.crop & this.field === "All") |
          (this.crop === "All" & this.field === "All") ) {
            let loca = quantityLocation(log.quantity, "Harvest");
            let tableRow = {
              date: dayjs.unix(log.timestamp).format('DD/MM/YYYY'),
              area: log.area[0].name,
              crop: this.IdToCropMap.get(log.data.crop_tid),
              yield: log.quantity[loca].value,
              units:log.quantity[loca].unit.name,
            }
            tableRows.push(tableRow)
          }
	      }
	      return tableRows
      }


    },

    methods: {
      
      generate: function() {
        this.result = [];
        let endTime = dayjs(this.enddate).unix();
        let startTime = dayjs(this.startdate).unix();
        let query = "/log.json?type=farm_harvest&timestamp[ge]="+ startTime+ "&timestamp[le]="+endTime
        getAllPages(query, this.result)
        .catch((error) => {
          console.log("Error");
          console.log(error);
        });


        if(this.harvestLogs.length <3 && this.rpStat){
          this.harvestLogs.push({date: "2018-05-02", area: "Chuau-1", crop: "Kale", yield: 10, units: "Bunches"});
        } else {
          axios.get('/farm.json')
          .then((res) => {
            this.Farm = res.data.name;
            this.User = res.data.user.name;
            this.Language = res.data.languages.en.name;
          })
          .catch((error) => {
            console.log("Error Occurs");
            console.log(error);
          });
          this.rpStat = true;
        }
      },
      deleteRecord: function(index) {
        this.result.splice(index, 1);
      }
    }
  });
  Vue.config.devtools = true;
</script>